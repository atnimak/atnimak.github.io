---
layout: post
title: Установка и настройка подключения по SSH
tags: windows linux ssh
---
Установка и настройка подключения по SSH.

---

## Установка и настройка SSH

Я подключаюсь с Windows машины или из под Ubuntu к серверу с Debian или Ubuntu. Чтобы установить SSH используем в debian-based дистрибутивах.
```
sudo apt-get install ssh
```
После завершения установки будет запущен SSH-сервер в режиме демона. Это можно проверить командой:
```
systemctl status sshd
```
или:
```
service sshd status
``` 
Теперь сервер работает с базовыми настройками по-умолчанию. К серверу уже можно подключиться по SSH, и это нормально работает в частных сетях, однако лучше бы исправить некоторые параметры для работы в публичных сетях. Настройки хранятся в файле по адресу **/etc/ssh/sshd_config**. Посмотреть его можно командой
```
cat /etc/ssh/sshd_config
```
Для редактирования вы можете использовать любой редактоор, я использую nano.
```
nano /etc/ssh/sshd_config
```
Обратим внимание на параметры **Port, AddressFamily, ListenAddress** 
**Port** задает номер порта, через который будет работать соединение, стандартный порт 22, часто подвергается сканированию ботами. Чтобы задать параметр убираем символ # в начале строки и указываем нужное значение, например 58292. Главное, чтобы порт не конфликтовал  с другими портами в системе, mysqld использует порт 3306, httpd — 80, ftpd — 21, поэтому выбирайте пятизначное значение, но не больше 65535.
```
Port 58292
```
**AddressFamily** задает семейство используемых адресов, IPv4 и IPv6, если используются только IPv4 адреса, то IPv6 можно отключить. AddressFamily **inet** - для IPv4 адресов и AddressFamily **inet6** для IPv6 адресов. По-умолчанию значение **any**.
```
AddressFamily inet
```
**PubkeyAuthentication** позволяет проводить авторизацию и шифрование трафика с помощью SSH-ключей.
 ```
PubkeyAuthentication yes
```
Также серверу можно явно указать, где хранятся открытые ключи пользователей. Это может быть как один общий файл для хранения ключей всех пользователей (обычно это файл etc/.ssh/authorized_keys), так и отдельные для каждого пользователя ключи. Второй вариант предпочтительнее в силу удобства администрирования и повышения безопасности.
Для общего файла:
```
AuthorizedKeysFile etc/ssh/authorized_keys
```
Для каждого пользователя. Благодаря шаблону автоподстановки с маской «%h» будет использоваться домашний каталог пользователя.
```
AuthorizedKeysFile %h/.ssh/authorized_keys
```
Обратите внимание, что вариант по-умолчанию
```
AuthorizedKeysFile .ssh/authorized_keys
```

Также безопасности ради можно отключить парольный доступ. Но прежде чем его отключать, настрой подключение по SSH-ключам, об этом ниже.
```
PasswordAuthentication no
```
И обязательно отключить идентификацию по пустому паролю:
```
PermitEmptyPasswords no
```
Следует также отключать root-доступ:
```
PermitRootLogin no
```
Значение по-умолчанию **PermitRootLogin prohibit-password** т.е. удалённый вход под пользователем root с парольной и интерактивной аутентификацией теперь запрещён. При указании значений without-password или prohibit-password допускается только аутентификация по ключам.

Для применения сделанных настроек необходим перезапуск SSH-сервера:
```
systemctl restart sshd
```
или
```
service sshd restart
```

Для подключения к серверу используется команда:
```
ssh user_name@host_name
```
Где user_name - имя пользователя. А host_name имя или ip адрес узла к которому производится подключение. Например:
```
ssh fred@192.168.1.25
```
При этом утилита ssh запросит (в зависимости от настроек сервера) логин, пароль или парольную фразу для разблокировки приватного ключа пользователя.

## Создание и настройка SSH ключей

Чтобы сгенерировать SSH-ключи на клиентской машине (то есть на той, на которой ты работаешь, не на сервере), выполни:
```
ssh-keygen
```
![Генерация ssh ключей](/assets/ssh-install-and-configure/ssh-key-1.png)
Введи путь к файлу, в который будут помещены ключи, каталог по-умолчанию указан в скобках, если не знаешь зачем, не меняй его. Если хочешь оставить расположение по умолчанию: нажми Enter. Пароль (passphrase) используется для огранчения доступа к закрытому ключу, пароль усложнит использование ключа третьми лицами в случае утраты. Если не хочешь использовать пароль: нажми Enter без заполнения строки.

При успешной генерации ключей ты увидишь что-то вот такое:
![Генерация ssh ключей](/assets/ssh-install-and-configure/ssh-key-2.png)

Открытый ключ хранится в файле */домашний_каталог/.ssh/id_rsa.pub*, закрытый — */домашний_каталог/.ssh/id_rsa*.

Можем посмотреть на них при помощи `cat`:
![Генерация ssh ключей](/assets/ssh-install-and-configure/ssh-key-3.png)

Осталось скопировать открытый ключ на сервер в файл 
*/домашний_каталог/.ssh/authorized_keys*. 

Внимание! Если на сервере еще нет папки .ssh в домашнем каталоге. Позаботься о его создании. Подключись к серверу, как ты подключаешься сейча, вероятно по паролю, и создай каталог:
```
cd ~/
mkdir .ssh
chmod 700 .ssh
```
![Генерация ssh ключей](/assets/ssh-install-and-configure/ssh-key-4.png)

Команда chmod устанавливает права доступа к папке: "Владелец может читать, записывать и запускать на выполнение; никто другой не имеет права выполнять никакие действия".

Итак, если папка уже есть, или мы ее создали. Отключаемся от сервера, переходим в папку с нашими ключами на клиенте. Т копируем ключ на сервер:
```
cat ~/.ssh/id_rsa.pub | ssh root@ip-адрес-сервера 'cat >> ~/.ssh/authorized_keys'
```

Также можно открыть файл *authorized_keys* на сервер редактором, например, nano и вставить строку с открытым ключом после `ssh-rca`
![Генерация ssh ключей](/assets/ssh-install-and-configure/ssh-key-5.png)

Еще один способ скопировать ключ в *authorized_keys*: команда `echo`, которая помещает строку в конец файла:
```
echo ssh-rsa строка-публичного-ключа >> /root/.ssh/authorized_keys
```
![Генерация ssh ключей](/assets/ssh-install-and-configure/ssh-key-6.png)

Другой способ перенести открытый ключ на сервер предлагает [beget.com](https://beget.com/ru/kb/how-to/ssh/avtomaticheskaya-ssh-avtorizacziya-po-klyuchu#sozdanie-ssh-klyuchey)
Копируем открытый ключ на удаленную систему при помощи `scp`
```
scp ~/.ssh/id_rsa.pub  user@remote.org.ua:~
```
Авторизуемся на удаленном сервере:
```
ssh user@remoute.org.ua
```
Заносим открытый ключ нашей локальный системы в авторизованные ключи удаленной системы, устанавливаем правильные права и "убираем за собой мусор":
```
# создаем директорию и даём права
remote$ [ -d ~/.ssh ] || (mkdir ~/.ssh; chmod 711 ~/.ssh)
# добавляем открытый ключ
remote$ cat ~/id_rsa.pub >> ~/.ssh/authorized_keys
# делаем правильные права
remote$ chmod 600 ~/.ssh/authorized_keys
# удаляем не нужное   
remote$ rm ~/id_rsa.pub                  
```

Теперь можно перейти к настройкам и отключить аутентификацию по паролю. Подключаемся к серверу, открываем **sshd_config**:
```
nano /etc/ssh/sshd_config
```
Раскомментируем строку *PasswordAuthentication* и вместо *yes* укажем *no*:
```
PasswordAuthentication no
``` 
![Генерация ssh ключей](/assets/ssh-install-and-configure/ssh-key-7.png)
Перезапускаем службу **sshd**:
```
systemctl restart sshd
```
или:
```
service sshd restart
```
Теперь можно подключаться к серверу: 
```
ssh fred@192.168.1.25
```
Или если вы меняли и порт, то
```
ssh fred@192.168.1.25 -p 58292
```
Понятно, что вместо 58292 должен быть наш номер порта. Также можно указать логин при помощи *-l*
```
ssh fred@192.168.1.25 -p 58292 -l fred
```

Если тебе нужно подключаться к серверу с нескольких машин есть два решения, [одно хорошее, другое простое](https://qna.habr.com/q/433464).
- Первое. Нужно сгенерировать на каждой машине новую пару ключей, и скопировать публичные ключи вручную на сервер, в файл `~/.ssh/authorized_keys` - один публичный ключ = одна строка.
- Второе. Ты можешь взять свой приватный ключ и положить его на все клиентские компьютеры. Не самое безопасное решение.

Если тебе нужно работать с несколькими приватными SSH ключами, [обрати внимание вот на эту статью techrocks.ru](https://techrocks.ru/2020/02/26/multiple-ssh-keys-managing/)

За помощь и некоторые скриншоты спасибо [firstvds.ru](https://firstvds.ru/technology/dobavit-ssh-klyuch), [itproffi.ru](https://itproffi.ru/ustanovka-i-nastrojka-servera-ssh-v-linux/). Также полезными были статьи [aitishnik.ru про настройку OpenSSH](https://www.aitishnik.ru/linux/ssh-debian/nastroyka-openssh.html) и про [генерацию ключей](https://www.aitishnik.ru/linux/ssh-debian/generatsiya-kliuchey.html).