---
layout: post
title: Как скопировать существующую операционную систему на виртуальную машину
tags: virtualbox
---

Задача: Перенести существующую Windows 10 со всеми настройками, файлами и дисками на виртуальную машину. Как оказалось, решений несколько, и все они весьма простые.

---

<script type="text/javascript" src="/public/js/jssor.slider.min.js"></script>

# Задача номер один - конвертировать существующие диски в виртуальные

Существует несколько способов перенести копию операционной системы на виртуальный диск, с помощью disk2vhd и с помощью средства резервного копирования Windows

## Способ первый - с помощью disk2vhd

Скачиваем [disk2vhd v2.01](https://docs.microsoft.com/ru-ru/sysinternals/downloads/disk2vhd) и запускаем.

- Снимаем галочку с пункта «Use Vhdx».
- В левой части окна отмечаем галочкой нужные диски, можно выбрать только диск с установленной Windows, мне же нужно было отметить все диски.
- Указываем место хранения и имя файла виртуального диска.

![Интерфейс программы disk2vhd](/assets/disk2vhd/dsk2vhd.jpg)

- нажимаете Create

И программа начнет создание виртуального диска, в зависимости размера это может занять значительное время. Когда программа закончит работу файл виртуального диска  с расширением .vhd будет находится в той папке, которую вы указали.

## Способ второй - с помощью резервного копирования Windows

Так как формат vhd принадлежит Microsoft, встроенное в Windows средство создания резервного образа системы, создает образы в формате vhd. Чтобы создать виртуальный диск нужно перейти:
*Панель управления->Система и безопасность->История файлов->Резервная копия образа системы*
![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/1.jpg)

Затем выбираем место сохранения резервного образа.

![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/2.jpg)

По умолчанию выбран диск С и скрытый раздел с файлами загрузки Windows.

![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/3.jpg)

Нажимаем Архивировать
![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/4.jpg)

Начнется процесс создания архива
![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/5.jpg)

Архивированный файл будет в папке  *WindowsImageBackup->Имя пользователя->Backup*

# Задача номер два - запустить сохраненную систему на виртуальной машине

Теперь нам нужно создать виртуальную машину и запустить ее. Иногда, при переносе Windows в виртуальную среду страдает загрузчик системы, который нам придется восстановить, чтобы это сделать мы загрузимся с iso-образа Windows и с помощью среды восстановления исправим загрузчик.

## Создание виртуальной машины

Скачиваем [VirtualBox](https://www.virtualbox.org/wiki/Downloads), устанавливаем и запускаем ее.
В главном окне нажимаем "Создать".
![Интерфейс VirtualBox](/assets/disk2vhd/v1.jpg)

Даем имя и выбираем тип  и версию системы в соответствии с тем, какую систему мы будем загружать
![Интерфейс VirtualBox](/assets/disk2vhd/v2.jpg)

Выделяем необходимое количество оперативной памяти. Для Windows 10 я ставлю не меньше 2048 Мб.
![Интерфейс VirtualBox](/assets/disk2vhd/v3.jpg)

Выбираем "Использовать существующий виртуальный диск" и нажимаем на кнопку проводника
![Интерфейс VirtualBox](/assets/disk2vhd/v4.jpg)

В проводнике находим нужный нам образ системы. Выделяем, нажимаем "Открыть".
![Интерфейс VirtualBox](/assets/disk2vhd/v5.jpg)

Нажимаем "Создать".
![Интерфейс VirtualBox](/assets/disk2vhd/v6.jpg)

Виртуальная машина создана, но при запуске скорее всего выдаст ошибку при загрузке.

## Исправление загрузчика
Это решение с исправлением загрузчика относиться только к MBR дискам и системам. С исправлением загрузчика в GPT еще не сталкивался, если будут проблемы придется дополнить заметку.

Чтобы исправить загрузчик нам нужно загрузиться в iso-образа и войти в среду восстановления. 
Для этого нажимаем "Настроить"
![Настройка VirtualBox](/assets/disk2vhd/z1.jpg)

На вкладке «Система» стрелочками меняем порядок загрузки, первым устройством выставляем - Оптический диск, а вторым - Жёсткий диск. Нажимаем "Ок".
![Настройка VirtualBox](/assets/disk2vhd/z2.jpg)

На вкладке "Носители" подключаем iso-образ. Выбираем пустое поле и нажимаем на значок диска.
![Настройка VirtualBox](/assets/disk2vhd/z3.jpg)

Нажимаем "Выбрать образ оптического диска" и выбираем iso-образ Windows. Во избежание конфликтов, той же версии Widows, как и система, которую мы пытаемся реанимировать.
![Настройка VirtualBox](/assets/disk2vhd/z4.jpg)
![Настройка VirtualBox](/assets/disk2vhd/z5.jpg)
![Настройка VirtualBox](/assets/disk2vhd/z6.jpg)

Настройка VirtualBox завершена. Нажимаем "Ок", тем самым сохраняем настройки.
![Настройка VirtualBox](/assets/disk2vhd/z7.jpg)

Запускаем виртуальную машину.
![Настройка VirtualBox](/assets/disk2vhd/z8.jpg)

На предложение загрузится с CD соглашаемся и нажимаем любую клавишу. После этого система загрузиться с нашего iso-образа.
![Настройка VirtualBox](/assets/disk2vhd/z9.jpg)

После загрузки нажимаем Shift+F10, чтобы открыть окно командной строки.
![Настройка VirtualBox](/assets/disk2vhd/w1.jpg)


Вводим команды:
- **diskpart**
- **lis vol** - выводим все разделы жёсткого диска или дисков (если их несколько) в список.
- **sel vol 1**  - в моем случае Том 1, это скрытый раздел System Reserved (Зарезервировано системой) размер 100 Мб - отвечающий за загрузку Windows 7, он некорректен (файловая система RAW) и его нужно удалить, а затем создать заново.
- **del vol** - удаляем некорректный раздел образуя нераспределённое пространство на жёстком диске.
- **lis dis** - выводим список дисков подключенных к компьютеру.
- **sel dis 0** - выбираем единственный Диск 0.
- **create par primary size=100** - создаём заново скрытый раздел System Reserved (Зарезервировано системой) размер 100 Мб.
- **format fs=NTFS** - форматируем его в файловую систему NTFS.
- **activ** - делаем активным.
- **assign** - присваиваем букву.
- **lis vol** - выводим все разделы накопителей подключенных к компьютеру в список.
- **exit**
- **bcdboot D:\Windows** - создаём заново файлы загрузки на скрытом разделе System Reserved для Windows, так как буква диска операционной системы в среде восстановления (D:)).

![Настройка VirtualBox](/assets/disk2vhd/w2.jpg)
![Настройка VirtualBox](/assets/disk2vhd/w3.jpg)

Выходим из командной строки, выключаем виртуальную машину, в настройках меняем порядок загрузки, как мы это делали раньше, только теперь первым делом ставим Жесткий диск, также можно удалить iso-образ из Оптического диска. Загружаемся уже не с iso-образа. Наша Windows должна успешно загрузиться.
![Настройка VirtualBox](/assets/disk2vhd/w4.jpg)

Иногда при попытке удаления тома raw возникает ошибка "память не может быть read". Это происходит, если мы пытаемся удалить защищенный раздел в помощью команды del vol. Disk2vhd копирует только выбранный нами раздел, но сохраняет также и структуру всего диска.

Такая ошибка возникает, если мы решим удалить защищённый раздел с помощью команды del vol. Disk2vhd копирует только выбранный нами раздел,но сохраняет структуру всего диска. RAW, это отсутствие файловой системы раздела, но так как ID разделов Disk2vhd сохраняет, нужно действовать немного по-другому. В командной строке вводим команды:

- **diskpart**
- **lis dis** - выводит список физических дисков
- **sel dis 0** - выбираем основной жёсткий диск
- **lis par** - показ всех разделов выбранного диска
- **sel par 3** - выбираем третий(в нашем случае третий, может быть другой раздел
- **del par override** - удаляем раздел, для удаления раздела ESP и MSR или раздела OEM-изготовителя ноутбука, необходимо указать параметр override

Теперь осталось установить "Дополнения гостевой ОС", после их установки VirtualBox настроит все драйвера и появился возможность переходить в "Режим полного экрана" и создавать общие папки.
![Настройка VirtualBox](/assets/disk2vhd/d1.jpg)

После того, как мы нажмем "Подключить образ диска Дополнения гостевой ОС" в CD приводе виртуальной машины появится диск с дополнениями. Нужно его открыть и установить программное обеспечение, которое на нем находится. После этого диск можно "изъять".

![Настройка VirtualBox](/assets/disk2vhd/d2.jpg)