---
layout: post
title: Как скопировать существующую операционную систему Windows на виртуальную машину
tags: virtualbox
---

Задача: Перенести существующую Windows 10 со всеми настройками, файлами и дисками на виртуальную машину. Как оказалось, решений несколько, и все они весьма простые.

---

<script type="text/javascript" src="/public/js/jssor.slider.min.js"></script>

## Задача номер один - конвертировать существующие диски в виртуальные

Существует несколько способов перенести копию операционной системы на виртуальный диск, с помощью disk2vhd и с помощью средства резервного копирования Windows

### Способ первый - с помощью disk2vhd

Скачиваем [disk2vhd v2.01](https://docs.microsoft.com/ru-ru/sysinternals/downloads/disk2vhd) и запускаем.

- Снимаем галочку с пункта «Use Vhdx».
- В левой части окна отмечаем галочкой нужные диски, можно выбрать только диск с установленной Windows, мне же нужно было отметить все диски.
- Указываем место хранения и имя файла виртуального диска.
- Нажимаем Create

![Интерфейс программы disk2vhd](/assets/disk2vhd/dsk2vhd.jpg)

И программа начнет создание виртуального диска, в зависимости размера это может занять значительное время. Когда программа закончит работу файл виртуального диска  с расширением .vhd будет находится в той папке, которую вы указали.

### Способ второй - с помощью резервного копирования Windows

Так как формат vhd принадлежит Microsoft, встроенное в Windows средство создания резервного образа системы, создает образы в формате vhd. Чтобы создать виртуальный диск нужно перейти:
*Панель управления->Система и безопасность->История файлов->Резервная копия образа системы*
![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/1.jpg)

Затем выбираем место сохранения резервного образа.

![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/2.jpg)

По умолчанию выбран диск С и скрытый раздел с файлами загрузки Windows.

![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/3.jpg)

Нажимаем Архивировать
![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/4.jpg)

Начнется процесс создания архива
![Интерфейс средства резервного копирования Windows](/assets/disk2vhd/5.jpg)

Архивированный файл будет в папке  *WindowsImageBackup->Имя пользователя->Backup*

## Задача номер два - запустить сохраненную систему на виртуальной машине

Теперь нам нужно создать виртуальную машину и запустить ее. Иногда, при переносе Windows в виртуальную среду страдает загрузчик системы, который нам придется восстановить, чтобы это сделать мы загрузимся с iso-образа Windows и с помощью среды восстановления исправим загрузчик.

### Установка VirtualBox и создание виртуальной машины

#### Windows

Установка VirtualBox на Windows не должна вызывать вопросов, поэтому просто скачиваем [VirtualBox](https://www.virtualbox.org/wiki/Downloads), устанавливаем и запускаем ее.

#### Linux

Есть два способа установки VirtualBox: из репозиториев ubuntu или из репозиториев Oracle.Чтобы установить из репозиториев ubuntu используйте:

```bash
sudo apt-get install virtualbox
```

После этого терминал запросит у вас пароль, введите его и ждите завершения загрузки и установки.

Установка из репозиториев Oracle более предпочтительна - версии там новее.
Сначала добавляем репозиторий:

```bash
echo "deb http://download.virtualbox.org/virtualbox/debian $(lsb_release -sc) contrib" | sudo tee -a /etc/apt/sources.list
```

Затем добавим ключи репозитория:

```bash
wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -
wget -q https://www.virtualbox.org/download/oracle_vbox.asc -O- | sudo apt-key add -
```

Обновляем список пакетов:

```bash
sudo apt-get update
```

Устанавливаем пакет для модулей ядра таких как vboxdrv и vboxnetflt:

```bash
sudo apt-get install dkms
```

Устанавливаем VirtualBox:

```bash
sudo apt-get install virtualbox-5.2
```

После того как VirtualBox установится, нам нужно добавить нашего пользователя в группу vboxusers:

```bash
sudo usermod -a -G vboxusers `whoami`
```

#### Создание вируальной машины

В главном окне нажимаем "Создать".
![Интерфейс VirtualBox](/assets/disk2vhd/v1.jpg)

Даем имя и выбираем тип  и версию системы в соответствии с тем, какую систему мы будем загружать
![Интерфейс VirtualBox](/assets/disk2vhd/v2.jpg)

Выделяем необходимое количество оперативной памяти. Для Windows 10 я ставлю не меньше 2048 Мб.
![Интерфейс VirtualBox](/assets/disk2vhd/v3.jpg)

Выбираем "Использовать существующий виртуальный диск" и нажимаем на кнопку проводника

![Интерфейс VirtualBox](/assets/disk2vhd/v4.jpg)

В проводнике находим нужный нам образ системы. Выделяем, нажимаем "Открыть".
![Интерфейс VirtualBox](/assets/disk2vhd/v5.jpg)

Нажимаем "Создать".

![Интерфейс VirtualBox](/assets/disk2vhd/v6.jpg)

Виртуальная машина создана, но при запуске скорее всего выдаст ошибку при загрузке.

### Исправление загрузчика
Это решение с исправлением загрузчика относиться только к MBR дискам и системам. С исправлением загрузчика в GPT еще не сталкивался, если будут проблемы придется дополнить заметку.

Чтобы исправить загрузчик нам нужно загрузиться в iso-образа и войти в среду восстановления. 
Для этого нажимаем "Настроить"
![Настройка VirtualBox](/assets/disk2vhd/z1.jpg)

На вкладке «Система» стрелочками меняем порядок загрузки, первым устройством выставляем - Оптический диск, а вторым - Жёсткий диск. Нажимаем "Ок".
![Настройка VirtualBox](/assets/disk2vhd/z2.jpg)

На вкладке "Носители" подключаем iso-образ. Выбираем пустое поле и нажимаем на значок диска.
![Настройка VirtualBox](/assets/disk2vhd/z3.jpg)

Нажимаем "Выбрать образ оптического диска" и выбираем iso-образ Windows. Во избежание конфликтов, той же версии Widows, как и система, которую мы пытаемся реанимировать.
![Настройка VirtualBox](/assets/disk2vhd/z4.jpg)
![Настройка VirtualBox](/assets/disk2vhd/z5.jpg)
![Настройка VirtualBox](/assets/disk2vhd/z6.jpg)

Настройка VirtualBox завершена. Нажимаем "Ок", тем самым сохраняем настройки.
![Настройка VirtualBox](/assets/disk2vhd/z7.jpg)

Запускаем виртуальную машину.
![Настройка VirtualBox](/assets/disk2vhd/z8.jpg)

На предложение загрузится с CD соглашаемся и нажимаем любую клавишу. После этого система загрузиться с нашего iso-образа.

![Настройка VirtualBox](/assets/disk2vhd/z9.jpg)

После загрузки нажимаем Shift+F10, чтобы открыть окно командной строки.
![Настройка VirtualBox](/assets/disk2vhd/w1.jpg)


Вводим команды:
- **diskpart**
- **lis vol** - выводим все разделы жёсткого диска или дисков (если их несколько) в список.
- **sel vol 1**  - в моем случае Том 1, это скрытый раздел System Reserved (Зарезервировано системой) размер 100 Мб - отвечающий за загрузку Windows 7, он некорректен (файловая система RAW) и его нужно удалить, а затем создать заново.
- **del vol** - удаляем некорректный раздел образуя нераспределённое пространство на жёстком диске.
- **lis dis** - выводим список дисков подключенных к компьютеру.
- **sel dis 0** - выбираем единственный Диск 0.
- **create par primary size=100** - создаём заново скрытый раздел System Reserved (Зарезервировано системой) размер 100 Мб.
- **format fs=NTFS** - форматируем его в файловую систему NTFS.
- **activ** - делаем активным.
- **assign** - присваиваем букву.
- **lis vol** - выводим все разделы накопителей подключенных к компьютеру в список.
- **exit**
- **bcdboot D:\Windows** - создаём заново файлы загрузки на скрытом разделе System Reserved для Windows, так как буква диска операционной системы в среде восстановления (D:)).

![Настройка VirtualBox](/assets/disk2vhd/w2.jpg)
![Настройка VirtualBox](/assets/disk2vhd/w3.jpg)

Выходим из командной строки, выключаем виртуальную машину, в настройках меняем порядок загрузки, как мы это делали раньше, только теперь первым делом ставим Жесткий диск, также можно удалить iso-образ из Оптического диска. Загружаемся уже не с iso-образа. Наша Windows должна успешно загрузиться.
![Настройка VirtualBox](/assets/disk2vhd/w4.jpg)

#### Возможные ошибки

##### Ошибка при удалении защищенного раздела

Иногда при попытке удаления тома raw возникает ошибка "память не может быть read". Это происходит, если мы пытаемся удалить защищенный раздел в помощью команды del vol. Disk2vhd копирует только выбранный нами раздел, но сохраняет также и структуру всего диска.

Такая ошибка возникает, если мы решим удалить защищённый раздел с помощью команды del vol. Disk2vhd копирует только выбранный нами раздел,но сохраняет структуру всего диска. RAW, это отсутствие файловой системы раздела, но так как ID разделов Disk2vhd сохраняет, нужно действовать немного по-другому. В командной строке вводим команды:

- **diskpart**
- **lis dis** - выводит список физических дисков
- **sel dis 0** - выбираем основной жёсткий диск
- **lis par** - показ всех разделов выбранного диска
- **sel par 3** - выбираем третий(в нашем случае третий, может быть другой раздел
- **del par override** - удаляем раздел, для удаления раздела ESP и MSR или раздела OEM-изготовителя ноутбука, необходимо указать параметр override

Далее действуем также, как описано выше - восстанавливаем загрузчик:

- **lis dis** - выводим список дисков подключенных к компьютеру.
- **sel dis 0** - выбираем единственный Диск 0.
- **create par primary size=100** - создаём заново скрытый раздел System Reserved (Зарезервировано системой) размер 100 Мб.
- **format fs=NTFS** - форматируем его в файловую систему NTFS.
- **activ** - делаем активным.
- **assign** - присваиваем букву.
- **lis vol** - выводим все разделы накопителей подключенных к компьютеру в список.
- **exit**
- **bcdboot D:\Windows** - создаём заново файлы загрузки на скрытом разделе System Reserved для Windows, так как буква диска операционной системы в среде восстановления (D:)).

После этого из командной строки, выключаем виртуальную машину, в настройках меняем порядок загрузки,как мы это делали раньше, только теперь первым делом ставим Жесткий диск, также можно удалить iso-образ из Оптического диска. Загружаемся уже не с iso-образа. Наша Windows должна успешно загрузиться.

##### Синий экран при запуске виртуальной машины

Иногда после восстановления загрузчика Windows не загружается и мы видим синий экран с ошибкой 0x0000007B. Это случается из-за того, что ваша система, которую теперь мы пытаемся запустить на виртуальной машине работала к контроллером IDE, а не SATA. Выключайте виртуальную машину, заходите в *Настройки -> Носители*. Выбирайте контроллер SATA и удаляйте его. 
![Настройка VirtualBox](/assets/disk2vhd/kontr1.jpg)

Затем добавляйте контроллер IDE.
![Настройка VirtualBox](/assets/disk2vhd/kontr2.jpg)

И прикрепляйте к нему наш виртуальный образ.
![Настройка VirtualBox](/assets/disk2vhd/kontr3.jpg)
![Настройка VirtualBox](/assets/disk2vhd/kontr4.jpg)

Запускаем виртуальную машину и радуемся.

##### Ошибка аппаратное ускорение (VT-x AMD-V) недоступно в вашей системе

Чтобы исправить эту ошибку нужно убедиться, что ваш процессор поддерживает апаратную виртуализацию. Для этого перезагружаемся и заходим в биос. Там ищем пункт, связанный с Virtual, Virtual mode или Virtualization. В некоторых версиях биос он находится на вкладке Advanced в пункте CPU Configuration и называется Secure Virtual Machine Mode, в других на вкладке Advanced BIOS Features, но он может называться по-другому. Напротив этого пункта нужно перевести переключатель из режима Disabled в режим Enabled.  Сохраняем изменения и выходим из BIOS.

Если вы не нашли нужного пункта в BIOS, и не знаете поддерживает ли ваш процессор аппаратную виртуализаци, попробуйте программу [SecurAble](https://www.grc.com/securable.htm). Она не требует установки, скачиваете, запускаете и в третьем столбце видите либо YES, значит виртуализация поддерживается и она уже включена, либо LOCKED, значит виртуализация поддерживается, но заблокировна в BIOS и нужно ее включить, либо NO, в этом случае аппаратная виртуализация не поддерживается.

Загружаемся, открываем VirtualBox и в настройках виртуальной машины находим
*Настройки -> Система -> Ускорение* И, если пункт VT-x AMD-V не отмечен галочкой, отмечаем и нажимаем ОК.
![Настройка VirtualBox](/assets/disk2vhd/err4.png)
Запускаем виртуальную машину.

### Настройка виртуальной машины

#### Дополнения гостевой OC: общие папки и общий буфер обмена

Теперь осталось установить "Дополнения гостевой ОС", после их установки VirtualBox настроит все драйвера и появится возможность переходить в "Режим полного экрана" и создавать общие папки и настроить общий буфер обмена с машиной хостом.
![Настройка VirtualBox](/assets/disk2vhd/d1.jpg)

После того, как мы нажмем "Подключить образ диска Дополнения гостевой ОС" в CD приводе виртуальной машины появится диск с дополнениями. Нужно его открыть и установить программное обеспечение, которое на нем находится. Во время установки могут появится предупреждения о несовместимости драйверов. Везде соглашайтесь с установкой. После этого диск можно "изъять". Чтобы дополнения заработали виртуальную машину придется перезапустить.

Установку Guest Additions (Дополнения гостевой ОС) на виртуальных машинах Linux удобнее выполнять через пакетный менеджер, а не через образ диска. Запустите терминал и установите:

```bash
sudo apt-get install virtualbox-guest-x11
```

```bash
sudo apt-get install virtualbox-guest-utils
```

Затем перезагрузите гостевую операционную систему.

##### Общий буфер обмена

Чтобы включить общий буфер обмена на запущенной виртуальной машине, в пункте меню *Устройства*, где мы выбирали "Подключить образ диска Дополнения гостевой ОС0", выбираем пункт *Общий буфер обмена* и выбираем *Двунаправленный*.

##### Полный экран и настройка экрана

Чтобы настроить режим полного экрана или чтобы экран гостевой машины соотвествовал экрану хост машины, на запущенной виртуальной машине выбираем *Вид* и выбираем *Подгонять размер экрана гостевой ОС* для того, чтобы подогнать разрешение экрана виртуальной машины под разрешение экрана вашей хост машины для комфортной работы. Там же можно выбрать *Режим интеграции дисплея* или *Полноэкранный режим* в зависимости от ваших нужд.

##### Общие папки

Чтобы удобно обмениваться файлами между хост и гостевой машинами настроим общую папку. Переходим в меню *Устройства -> Общие папки -> Настроить общие папки*. Значком *+* добавляем общую папку и в открывшемся окне проводника выбираем путь к папке, отмечаем галочками *Автоподключение* и *Создать постоянную папку*. Нажимаем сохранить, чтобы закрыть оба окна и, если и хостовая и гостевая машина у вас Windows перезагружаем компьютер, чтобы общая папка была готова к использованию. Файлы в общей папке видны одновременно и на хост и на гостевой машине. 

Если хост или гостевая машина у вас Linux, то перед тем как перезагружать компьютер нужно добавить своего пользователя в группу vboxsf, если вы не сделали этого раньше, на этапе установки VirtualBox. На Linux машине используйте команду, где вместо user укажите имя пользователя, от которого вы будете запускать файловый менеджер:

```bash
sudo usermod -aG vboxsf user
```

После этого перезагрузите компьютер.

Если после перезагрузки в гостевой машине Windows не появилась общая папка подключите сетевой диск, который находится по адресу *\\vboxsvr\имя_папки*.
имя_папки - то самое имя, которые Вы дали расшаренной директории.

#### Оптимизация: VMware OS Optimization Tool

Для виртуальных машин на Windows я использую [VMware OS Optimization Tool](https://labs.vmware.com/flings/vmware-os-optimization-tool). Скачиваем архив, распаковываем и запускаем программу на нашей виртуальной машине. Не на хосте.
![Настройка VirtualBox](/assets/disk2vhd/vmware1.png)

В окне программы мы видим доступные опции для оптимизации. Многие из них включены по-умолчанию. В левом нижнем углу кнопка, чтобы запустить оптимизацию - "Optimize".
![Настройка VirtualBox](/assets/disk2vhd/vmware2.png)

Начнется процесс оптимизации, после завершения которого ваша Windows будет работать значительно быстрее и потреблять меньше оперативной памяти.
![Настройка VirtualBox](/assets/disk2vhd/vmware3.png)

**Важно** Отдельно хочу посоветовать, пробежаться глазами по включенным пунктам оптимизации и снять галочки с тех пунктов, которые вам оптимизировать не нужно, например, один из пунктов отключает OneDrive и если вы собираетесь его использовать на виртуальной машине снимите галочку с соответствующего пункта.

Несмотря на то, что VMware OS Optimization Tool делает бекап реестра и все измененные пункты можно откатить назад, если что-то пойдет не так, рекомендую сделать снапшот (снимок состояния виртуальной машины) прежде чем запускать утилиту - снапшоты использовать куда удобнее и безопаснее, чем восстанавливать бекап реестра.

P.S. Спасибо админу [remontcompa.ru](https://remontcompa.ru) за [эту статью](https://remontcompa.ru/885-perenos-windows-7-so-stacionarnogo-kompyutera-na-virtualnuyu-mashinu-virtualbox-ustanovlennuyu-na-noutbuke-s-windows-10.html) и [вот эту статью](https://remontcompa.ru/876-kak-sozdat-fayl-virtualnogo-zhestkogo-diska-vhd.html), а также [remontka.pro](https://remontka.pro) за [этот материал про создание виртуального диска](https://remontka.pro/virtual-hdd-windows/) и [вот этот про восстановление загрузчика в Windows 10](https://remontka.pro/windows-10-bootloader-fix/). За часть скриншотов спасибо [losst.ru](https://losst.ru/kak-ustanovit-windows-10-na-virtualbox)